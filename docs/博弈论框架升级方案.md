# 博弈/流动性视角框架升级方案（落地版）

> 日期：2026-01-23  
> 目的：把“博弈论”从爽文概念，落成 **可计算因子/可回测规则/可 SQL 查询输出**。  
> 适用：A股（ETF/股票）日线/周线研究工具；不构成投资建议。

---

## 0. 红线（不守=自欺欺人）

必须遵守：`docs/框架升级/00_constraints.md`

- **禁止未来函数**：所有信号都以 `<= as_of` 数据计算；如用当日收盘，执行必须 **T+1**。
- **禁止过拟合**：任何“优化/动态权重/机器学习”必须 walk-forward；先研究闭环再谈上线。
- **成本/可交易性必须进入口径**：最低佣金 5 元、滑点、涨跌停/停牌/流动性门槛。
- **输出必须结构化可复现**：产物带 `symbol/asset/as_of/source/ref_date`；写入 `outputs/` 并可进 DuckDB。

---

## 1. 总体思路：别“预判意图”，先把可观测的博弈现象做成因子

所谓“机构意图/散户行为”，如果没数据支撑，最后一定变成玄学。

更稳的落地方式是：

1) **定义博弈现象**（能从价格/量/资金 proxy 里观测）  
2) **做成因子**（输出 `FactorResult(score/direction/confidence/details)`）  
3) **先研究验证**（IC/IR/衰减/成本敏感性/样本外）  
4) **再决定进不进策略**（大部分只当过滤器/风控项，不当“开仓圣杯”）

---

## 2. 当前仓库可用的输入（MVP 数据口径）

### 2.1 OHLCV（核心）
- 日线/周线 OHLCV（AkShare/TuShare，项目已有 `fetch_daily` / `tushare_kline`）
- 派生指标（项目已有）：MA/MACD/RSI/ATR/ADX/Donchian/Ichimoku/Bollinger/OBV/MFI/A/D 等

### 2.2 资金/交易结构 proxy（可选但很值钱）
- **北向/南向**（TuShare `moneyflow_hsgt`）：已有实现入口（见 `llm_trading/tushare_factors.py`、`llm_trading/national_team.py`）
- **宏观利率/ERP proxy**（Shibor 1Y 或 10Y 国债）：可作为“风险温度计”（不是买卖理由）
- **微观交易结构**（大单/超大单等）：如果 TuShare 有稳定接口/积分允许，作为“资金确认”因子使用

> 约束：任何外部源都要 **缓存+TTL+降级**；接口挂了不能把主流程搞崩。

---

## 3. 可落地的“博弈因子”设计（先做这些，别急着写决策器）

下面因子都只依赖 OHLCV + 少量派生指标，先落地、先验证。

### 3.1 流动性猎杀/陷阱因子：`liquidity_trap`

**目标**：识别“假突破/假跌破”（散户止损/追涨的流动性被扫走），把它当成：
- 右侧策略的 **风控过滤器**（避免追在陷阱里）
- 逆向策略的 **触发前置条件**（等猎杀完成再动手）

**定义（示例，日线）**：
- 找 `lookback=N` 内摆动高点 `swing_high`、摆动低点 `swing_low`
- `bull_trap`：
  - `high > swing_high * (1 + sweep_pct)` 且 `close < swing_high`
  - `volume_ratio` 或 `amount_ratio` 放大（可选）
- `bear_trap`：
  - `low < swing_low * (1 - sweep_pct)` 且 `close > swing_low`
  - 同样看放量确认

**输出建议**：
- `score`：陷阱强度（0-1）
- `direction`：`bearish`（牛陷阱=短期偏空）/`bullish`（熊陷阱=短期偏多）/`neutral`
- `details`：`swing_high/swing_low/sweep_pct/close_vs_level/volume_ratio/...`

### 3.2 止损聚集区 proxy：`stop_cluster`

**目标**：别装神弄鬼说“散户止损在哪”，我们只输出“可能聚集的显著位置”，供策略做距离约束。

**候选聚集区（按优先级）**：
1) 近 `N` 期摆动高/低
2) 关键均线（MA20/MA60/MA200）附近
3) 整数/半整数位（对 ETF/低价股特别明显）

**输出**：
- 给出 `zones=[{level, kind, distance_pct}]`，并给一个“当前是否贴近聚集区”的分数

### 3.3 情绪极值 proxy：`capitulation` / `fomo`

**capitulation（投降式抛售）**：用来识别“恐慌释放”，不是抄底理由，是“可以开始观察反转条件”的信号。
- 条件示例：`down_move > k*ATR` + 放量 + RSI 低位（或长下影线）

**fomo（追涨狂热）**：用来识别“冲高风险”，不是做空理由，是“别追/考虑分批兑现”的信号。
- 条件示例：`up_move > k*ATR` + 放量 + RSI 高位 + 偏离 MA20/MA60 过大

### 3.4 震荡吸筹/派发 proxy：`wyckoff_phase_proxy`（先叫 proxy，别叫意图）

先落地可计算的特征组合，不要一上来就硬分类四阶段。

可用特征（例）：
- 区间性：`range_width`（近 N 期高低差/均价）
- 波动收缩：ATR/布林带带宽收缩
- 量价背离：OBV/A-D 与价格背离

输出：
- `score_accumulation_like` / `score_distribution_like`（两个分数比硬分类更稳）

---

## 4. 与现有策略整合方式（KISS：先当“过滤器/触发条件”，别当圣杯）

### 4.1 右侧趋势/回踩（BBB/趋势类）
- **禁止在 bull_trap 强时追突破**
- 允许在 `bear_trap` 后，出现右侧确认（重新站回关键位/均线）再介入

### 4.2 逆向/均值回归（小资金少做）
- `capitulation` 只是“进入观察窗口”
- 真正入场要有确认：例如 `bear_trap` + 次日/次周收回关键位 + 量能衰减

### 4.3 大盘/国家队（现有模块继续做，但口径要更诚实）
`national_team.py` 这类更适合输出“**市场风险温度计**”，用于：
- 降低仓位/提高现金比例
- 决定“只做ETF、不碰小票”的风控开关

---

## 5. 输出规范（必须可 SQL）

建议在单标的 `analyze --method all` 时新增：
- `outputs/<run>/game_theory_factors.json`（或并入 `tushare_factors.json` 的同级）

结构建议：
```json
{
  "schema": "llm_trading.game_theory_factors.v1",
  "symbol": "sh510300",
  "asset": "etf",
  "as_of": "2026-01-23",
  "source": "factors",
  "ref_date": "2026-01-23",
  "factors": {
    "liquidity_trap": {"score": 0.72, "direction": "bearish", "confidence": 0.8, "details": {}},
    "capitulation": {"score": 0.10, "direction": "neutral", "confidence": 0.6, "details": {}}
  }
}
```

并在 `llm_trading/warehouse.py` 加视图把这类 JSON 变成可查表（保持 KISS）。

---

## 6. 实施路线（对齐 `docs/框架升级`）

### P0：先研究闭环（Phase1）
1) 把上面 3.x 因子作为 **候选因子** 纳入因子库  
2) 跑 IC/IR/衰减/成本敏感性/样本外  
3) 产出白名单/黑名单（垃圾因子直接淘汰）

### P1：再迁移/集成（Phase2）
1) 将通过验证的因子作为过滤器接入 BBB/短线策略  
2) 输出信号对齐报告，确认没有引入未来函数

### P2：再谈动态权重/元策略（Phase3）
有证据再做；没有证据就别做，别把系统写成玄学引擎。

