# 小散特化交易框架方案（落地版）

> 日期：2026-01-23  
> 核心理念：小散的优势不是“更聪明”，是 **可以不做、可以等、成本更敏感、仓位更灵活**。  
> 目标：把这些优势写成 **可执行规则 + 可回测口径 + 可 SQL 化产物**，而不是口号。

---

## 0. 红线（必须遵守）

统一遵守：`docs/框架升级/00_constraints.md`

- **T+1 与未来函数**：日线/周线信号一律按 `<= as_of` 计算；用收盘价的信号默认次日执行。
- **交易成本必须进入决策**：最低佣金 5 元是小资金的“刀”，不把它算进去，结果一定虚。
- **可交易性约束**：涨跌停/停牌/流动性不足时，信号再好也没法执行，必须过滤或在报告标注。

---

## 1. 小散优势怎么“工程化”

我们不追求“预测”，追求“少犯错 + 少交易 + 只做肥球”。

落地成三件事（按优先级）：

1) **空仓信号（CashSignal）**：环境不对就躺平，避免系统性亏损  
2) **机会评分（OpportunityScore）**：只做评分高、结构清晰、成本吃得起的机会  
3) **仓位管理（PositionSizing）**：不靠情绪，靠规则；上限硬约束

可选增强：
- **流动性陷阱过滤**（假突破/假跌破）——避免被猎杀  
- **小盘股猎手**（需要市值/流动性/风控数据，先后置）

---

## 2. 当前仓库可直接复用的“因子/信号”

我们已经有因子库骨架：`llm_trading/factors/`（17 个因子），还有成熟指标与策略输出。

可直接当 OpportunityScore 的输入维度：
- 趋势：`ma_cross`、`macd`、`ichimoku`、`adx`
- 动量：`rsi`、`roc`、`momentum`
- 量能：`volume_ratio`、`obv`、`mfi`
- 波动：`atr`、`bollinger`
- 形态：`pullback`、`zt_type`（偏短线）
- 市场：`regime`、`breadth`

TuShare 补充因子（如果可用）：
- `ERP(Shibor1Y/10Y)`（风险温度计，不是买卖按钮）
- `northbound`（北向/南向资金 proxy）
- `microstructure`（大单/超大单净流 proxy）

---

## 3. 三个核心模块（MVP 设计）

### 3.1 CashSignal：环境不对就空仓

**输入**：市场状态（regime）、波动（ATR/波动率 proxy）、机会评分分布（本周候选平均分/Top 分数）、账户近期连亏（可选）

**输出（结构化）**：
```json
{
  "schema": "llm_trading.cash_signal.v1",
  "as_of": "2026-01-23",
  "should_stay_cash": true,
  "cash_ratio": 0.8,
  "reason": "regime=bear + 波动偏高 + 机会评分不足",
  "expected_duration_days": 10
}
```

**执行口径（建议）**：
- `regime=bear`：默认现金 80~100%（除非是“强纪律网格/特殊标的”）
- `regime=neutral`：现金 40~60%
- `regime=bull`：现金 0~30%（但仍受机会评分约束）

> 小散最强技能：不交易。把“忍住”写进系统里。

### 3.2 OpportunityScore：只做肥球（0~1）

**目标**：把“看起来不错”变成一个可解释的分数，并设一个门槛（默认 0.70）。

**建议输入维度（先 KISS）**
- `trend_score`：趋势是否明确（ma_cross/macd/ichimoku）
- `risk_reward_score`：结构上是否能给出清晰失效位（pullback/关键位距离/ATR）
- `liquidity_score`：成交额门槛 + 量能确认（amount_avg20 / volume_ratio）
- `regime_score`：市场状态是否允许该类交易（regime）
- `trap_risk`：流动性陷阱风险（见 3.4，可先后置）

**输出（结构化）**：
```json
{
  "schema": "llm_trading.opportunity_score.v1",
  "symbol": "sh510300",
  "asset": "etf",
  "as_of": "2026-01-23",
  "total_score": 0.78,
  "min_score": 0.70,
  "verdict": "tradeable",
  "components": {
    "trend": 0.82,
    "regime": 0.70,
    "risk_reward": 0.75,
    "liquidity": 0.85,
    "trap_risk": 0.20
  },
  "details": {
    "key_level": "MA50",
    "invalidation": "close < MA50",
    "expected_holding_days": 10
  }
}
```

**门槛建议**：
- `total_score < 0.70`：默认不做（空仓也算一种决策）
- `0.70~0.80`：小仓试错
- `>0.80`：允许按规则加到上限

> 注意：评分不是为了“找更多交易”，而是为了“拒绝垃圾交易”。

### 3.3 PositionSizing：仓位管理（成本敏感版）

**现实约束**（系统里必须显式处理）：
- 最低佣金 5 元：小额交易会被磨到怀疑人生
- 股票 lot_size 通常 100 股（ETF 通常 1 份）
- 最小交易额建议：`>= 2000`（你现有规则就是这么定的）

**MVP 建议（先别上凯利神功）**：
- 默认用“固定上限 + 置信度折扣”：
  - `position_pct = min(max_position_pct, base_pct * confidence)`
  - `base_pct` 可按策略类型：趋势=0.25，均值回归=0.15，事件短线=0.10（示例）
- 若要用凯利：必须基于样本外胜率/赔率统计，并且只能 **半凯利/四分之一凯利 + 硬上限**。

**输出**：
```json
{
  "schema": "llm_trading.position_sizing.v1",
  "symbol": "sh510300",
  "as_of": "2026-01-23",
  "max_position_pct": 0.30,
  "suggest_position_pct": 0.18,
  "reason": "score=0.78, confidence=0.60, regime=neutral"
}
```

---

## 3.4（可选）流动性陷阱过滤：避免被“假突破”收割

实现口径与 `docs/博弈论框架升级方案.md` 的 `liquidity_trap` 因子保持一致：
- 看“突破是否站稳”（收盘是否回到关键位内）
- 看“是否放量扫流动性”

小散执行原则很简单：
- 看见“放量突破”先别兴奋，先问一句：**收盘站住了没？**
- 没站住就当成陷阱风险：评分扣分或直接禁止交易。

---

## 4. 与现有系统的集成方式（怎么落到代码里）

### 4.1 不新增“超级策略”，只新增“评分/过滤器”

推荐集成点（按影响面从小到大）：
1) `analyze`：输出 `opportunity_score.json` / `cash_signal.json`（或并入 `report.json`）
2) `scan-etf/scan-stock`：排名结果附加评分字段，并可 `--min-score` 过滤
3) `holdings-user/rebalance-user`：用 CashSignal 控制整体仓位，用 OpportunityScore 控制调仓候选质量

### 4.2 输出必须能 SQL

所有新增输出都必须：
- 写入 `outputs/<run>/...json`
- 在 `llm_trading/warehouse.py` 增加 `wh.v_*` 视图（扁平字段，别嵌套大对象）

---

## 5. 实施路线图（对齐 `docs/框架升级`）

### Phase1（P0）：先研究闭环
- 把 OpportunityScore 的输入（因子分数）与未来收益对齐
- 做 IC/IR/衰减/成本敏感性/样本外
- 形成“可用因子白名单”

### Phase2（P1）：再接入策略与调仓
- 先并行输出评分，不强制改变老信号
- 验证对齐后，逐步将评分作为过滤器启用

---

## 6. 重要提醒（别把自己写进坑里）

- “小资金高胜率策略”的很多外部回测（SPY/R3/海龟）只能当启发；A股有涨跌停、T+1、流动性分层，口径不对会死人。
- 小散系统最容易失败的地方不是信号，是：**过度交易 + 忽视成本 + 不认输**。
- 我们的框架核心就是：用规则帮你“少做错事”，而不是天天给你喊单。

